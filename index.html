<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Business Profit Calculator</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for profit/loss display */
    .profit-text {
      color: green;
      font-weight: bold;
    }
    .loss-text {
      color: red;
      font-weight: bold;
    }
    /* Styles for error and warning messages */
    .error-message {
      background-color: #fee2e2; /* bg-red-100 */
      border: 1px solid #fca5a5; /* border-red-400 */
      color: #b91c1c; /* text-red-700 */
      padding: 0.75rem 1rem;
      border-radius: 0.25rem;
      position: relative;
    }
    .warning-message {
      background-color: #fffbeb; /* bg-yellow-100 */
      border: 1px solid #fcd34d; /* border-y              <div class="text-right">
                <p class="text-sm text-gray-600">á€›á€±á€¬á€„á€ºá€¸á€…á€»á€±á€¸: ${formatNumber(calc.soldAmount)} MMK</p>
                <p class="text-sm text-gray-600">á€•á€«á€á€„á€ºá€„á€½á€±: ${formatNumber(calc.totalInvestment)} MMK</p>
                <p class="text-sm ${profitClass}">${profitText}: ${formatNumber(Math.abs(calc.totalProfit))} MMK</p>
              </div>-400 */
      color: #b45309; /* text-yellow-700 */
      padding: 0.75rem 1rem;
      border-radius: 0.25rem;
      position: relative;
    }

    /* Mobile-specific card styles */
    .mobile-share-card {
      background-color: white;
      padding: 0.75rem;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      margin-bottom: 0.75rem;
    }
    .mobile-share-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.375rem 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .mobile-share-item:last-child {
      border-bottom: none;
    }
    .mobile-share-item-label {
      font-size: 0.75rem;
      font-weight: 500;
      color: #6b7280;
    }
    .mobile-share-item-value {
      font-size: 0.75rem;
      font-weight: 600;
      color: #1f2937;
    }
    .mobile-share-name {
      font-size: 0.875rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 0.5rem;
    }
    
    /* Custom flex utilities */
    .flex-2 {
      flex: 2;
    }
    
    /* Input focus styles */
    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #3b82f6; /* Blue border on focus */
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); /* Light blue glow */
    }
    
    /* Share entry container */
    .share-entry-container {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 0.5rem;
      background-color: #f9fafb;
      margin-bottom: 1rem;
    }
    
    /* Mobile layout adjustments */
    @media (max-width: 640px) {
      .share-entry {
        flex-direction: column;
        gap: 0.5rem;
      }
      .share-entry.space-x-2 > * + * {
        margin-left: 0; /* Remove horizontal spacing on mobile */
      }
      .share-entry > * {
        width: 100%;
        margin-bottom: 0;
      }
      .amount-remove-row {
        display: flex;
        gap: 0.5rem;
        width: 100%;
        margin-left: 0 !important; /* Force remove any left margin */
      }
      .amount-remove-row input {
        flex: 1;
        width: 0; /* Reset width to let flex handle it */
      }
      .amount-remove-row button {
        flex-shrink: 0;
        width: auto;
      }
      
      /* Reduce main container padding on mobile */
      .main-container {
        padding: 1rem !important;
      }
      
      /* Mobile navigation adjustments */
      .nav-header {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }
      .nav-header h1 {
        font-size: 1.125rem; /* text-lg */
        text-align: center;
        width: 100%;
      }
      .nav-buttons {
        justify-content: center;
        gap: 0.5rem;
      }
      .nav-buttons button {
        flex: 1;
        max-width: 100px;
        text-align: center;
        padding: 0.5rem 0.5rem;
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-4xl bg-white shadow-lg rounded-xl p-6 space-y-6 main-container">
    <!-- Main Title and Navigation Header -->
    <div class="nav-header flex justify-between items-center border-b border-gray-200 pb-4">
      <h1 class="text-xl md:text-2xl font-bold">ğŸ“ˆ á€¡á€™á€¼á€á€ºá€„á€½á€±á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯</h1>
      <div class="nav-buttons flex space-x-2">
        <button id="historyBtn" onclick="showHistoryPanel()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm">ğŸ“‹ á€™á€¾á€á€ºá€á€™á€ºá€¸</button>
        <button id="summaryBtn" onclick="showSummaryPanel()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded text-sm hidden">ğŸ“ˆ á€¡á€”á€¾á€…á€ºá€á€»á€¯á€•á€º</button>
        <button id="newCalcBtn" onclick="showNewCalculation()" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded text-sm hidden">â• á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€¡á€á€…á€º</button>
      </div>
    </div>

    <!-- Main Calculator View -->
    <div id="calculatorView">
      <div>
        <label for="soldAmount" class="block text-sm font-medium">á€›á€±á€¬á€„á€ºá€¸á€…á€»á€±á€¸ (á€™á€¼á€”á€ºá€™á€¬á€€á€»á€•á€º)</label>
        <input id="soldAmount" type="number" class="mt-1 w-full border border-gray-300 rounded px-4 py-2" placeholder="á€¥á€•á€™á€¬ - 87700000" />
      </div>

      <div id="sharesContainer" class="space-y-4 mt-6">
      <div class="share-entry-container">
        <div class="share-entry flex space-x-2">
          <input type="text" class="share-name flex-1 border border-gray-300 rounded px-2 py-1" placeholder="á€›á€¾á€šá€ºá€šá€¬á€›á€¾á€„á€ºá€¡á€™á€Šá€º" />
          <div class="amount-remove-row flex-2 flex space-x-2 sm:contents">
            <input type="number" class="share-amount flex-1 border border-gray-300 rounded px-2 py-1" placeholder="á€•á€«á€á€„á€ºá€„á€½á€±" />
            <button onclick="removeShareField(this)" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm flex-shrink-0">Ã—</button>
          </div>
        </div>
      </div>
    </div>

    <div class="border-t border-gray-200 pt-4">
      <button onclick="addShareField()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm">+ á€›á€¾á€šá€ºá€šá€¬á€›á€¾á€„á€ºá€‘á€•á€ºá€‘á€Šá€·á€ºá€›á€”á€º</button>
    </div>

    <div class="text-center">
      <button onclick="calculateProfit()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded mt-4">á€á€½á€€á€ºá€á€»á€€á€ºá€•á€«</button>
    </div>

    <div id="results" class="space-y-2"></div>
    </div>

    <!-- History Panel View -->
    <div id="historyView" class="hidden space-y-6">
      <h2 class="text-xl font-semibold">ğŸ“‹ á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€»á€¬á€¸</h2>
      <div id="historyList" class="space-y-3">
        <!-- History entries will be populated here -->
      </div>
      <div id="emptyHistory" class="text-center text-gray-500 py-8 hidden">
        <p>á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€»á€¬á€¸á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹</p>
        <p class="text-sm">á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€™á€»á€¬á€¸á€œá€¯á€•á€ºá€•á€¼á€®á€¸á€”á€±á€¬á€€á€º áá€„á€ºá€¸á€á€­á€¯á€·á€€á€­á€¯ á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€™á€¼á€„á€ºá€á€½á€±á€·á€”á€­á€¯á€„á€ºá€™á€Šá€ºá‹</p>
      </div>
    </div>

    <!-- Detail View -->
    <div id="detailView" class="hidden space-y-6">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-semibold" id="detailTitle">á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯ á€¡á€á€±á€¸á€…á€­á€á€º</h2>
        <div class="flex space-x-2">
          <button onclick="loadCalculation()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm">ğŸ“ Load</button>
          <button onclick="deleteCalculation()" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm">ğŸ—‘ï¸ Delete</button>
        </div>
      </div>
      <div id="detailContent" class="space-y-4">
        <!-- Detail content will be populated here -->
      </div>
    </div>

    <!-- Summary View -->
    <div id="summaryView" class="hidden space-y-6">
      <h2 class="text-xl font-semibold">ğŸ“ˆ á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€™á€»á€¬á€¸ á€¡á€”á€¾á€…á€ºá€á€»á€¯á€•á€º</h2>
      
      <!-- Filter Controls -->
      <div class="mobile-share-card">
        <h3 class="mobile-share-name">á€…á€…á€ºá€‘á€¯á€á€ºá€›á€”á€º</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">á€”á€¾á€…á€ºá€¡á€œá€­á€¯á€€á€º</label>
            <select id="yearFilter" onchange="updateSummary()" class="w-full border border-gray-300 rounded px-3 py-2">
              <option value="">á€”á€¾á€…á€ºá€¡á€¬á€¸á€œá€¯á€¶á€¸</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">á€œá€¡á€œá€­á€¯á€€á€º</label>
            <select id="monthFilter" onchange="updateSummary()" class="w-full border border-gray-300 rounded px-3 py-2">
              <option value="">á€œá€¡á€¬á€¸á€œá€¯á€¶á€¸</option>
              <option value="0">á€‡á€”á€ºá€”á€á€«á€›á€®</option>
              <option value="1">á€–á€±á€–á€±á€¬á€ºá€á€«á€›á€®</option>
              <option value="2">á€™á€á€º</option>
              <option value="3">á€§á€•á€¼á€®</option>
              <option value="4">á€™á€±</option>
              <option value="5">á€‡á€½á€”á€º</option>
              <option value="6">á€‡á€°á€œá€­á€¯á€„á€º</option>
              <option value="7">á€á€¼á€‚á€¯á€á€º</option>
              <option value="8">á€…á€€á€ºá€á€„á€ºá€˜á€¬</option>
              <option value="9">á€¡á€±á€¬á€€á€ºá€á€­á€¯á€˜á€¬</option>
              <option value="10">á€”á€­á€¯á€á€„á€ºá€˜á€¬</option>
              <option value="11">á€’á€®á€‡á€„á€ºá€˜á€¬</option>
            </select>
          </div>
          <div class="flex items-end">
            <button onclick="clearFilters()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded text-sm w-full">
              ğŸ”„ á€›á€¾á€„á€ºá€¸á€œá€„á€ºá€¸á€›á€”á€º
            </button>
          </div>
        </div>
      </div>

      <!-- Summary Statistics -->
      <div id="summaryStats" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <!-- Statistics will be populated here -->
      </div>

      <!-- Filtered Calculations List -->
      <div id="filteredCalculations" class="space-y-3">
        <!-- Filtered calculations will be populated here -->
      </div>
    </div>

  </div>

  <script>
    // Global variables for managing state
    let currentView = 'calculator';
    let selectedCalculationId = null;

    // Helper function for consistent number formatting
    function formatNumber(number) {
      return Math.round(number).toLocaleString();
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      // Check if there are already share fields, if not add one
      const container = document.getElementById('sharesContainer');
      if (container.children.length === 0) {
        addShareField();
      }
      loadHistoryList();
    });

    // View management functions
    function showHistoryPanel() {
      currentView = 'history';
      document.getElementById('calculatorView').classList.add('hidden');
      document.getElementById('historyView').classList.remove('hidden');
      document.getElementById('detailView').classList.add('hidden');
      document.getElementById('summaryView').classList.add('hidden');
      document.getElementById('historyBtn').classList.add('hidden');
      document.getElementById('summaryBtn').classList.remove('hidden');
      document.getElementById('newCalcBtn').classList.remove('hidden');
      loadHistoryList();
    }

    function showNewCalculation() {
      currentView = 'calculator';
      document.getElementById('calculatorView').classList.remove('hidden');
      document.getElementById('historyView').classList.add('hidden');
      document.getElementById('detailView').classList.add('hidden');
      document.getElementById('summaryView').classList.add('hidden');
      document.getElementById('historyBtn').classList.remove('hidden');
      document.getElementById('summaryBtn').classList.add('hidden');
      document.getElementById('newCalcBtn').classList.add('hidden');
      clearCalculation();
    }

    function showSummaryPanel() {
      currentView = 'summary';
      document.getElementById('calculatorView').classList.add('hidden');
      document.getElementById('historyView').classList.add('hidden');
      document.getElementById('detailView').classList.add('hidden');
      document.getElementById('summaryView').classList.remove('hidden');
      document.getElementById('historyBtn').classList.remove('hidden');
      document.getElementById('summaryBtn').classList.add('hidden');
      document.getElementById('newCalcBtn').classList.remove('hidden');
      initializeSummaryView();
    }

    function showDetail(calculationId) {
      currentView = 'detail';
      selectedCalculationId = calculationId;
      document.getElementById('calculatorView').classList.add('hidden');
      document.getElementById('historyView').classList.add('hidden');
      document.getElementById('detailView').classList.remove('hidden');
      document.getElementById('summaryView').classList.add('hidden');
      loadDetailView(calculationId);
    }

    function clearCalculation() {
      document.getElementById('soldAmount').value = '';
      document.getElementById('results').innerHTML = '';
      
      // Clear all share fields and add one empty field
      const container = document.getElementById('sharesContainer');
      container.innerHTML = '';
      addShareField();
    }

    // Storage functions
    function saveCalculation(calculationData) {
      const calculations = getStoredCalculations();
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
      });
      
      const calculation = {
        id: Date.now().toString(),
        name: `Calculation - ${dateStr}`,
        date: now.toISOString(),
        ...calculationData
      };
      
      calculations.push(calculation);
      localStorage.setItem('profitCalculations', JSON.stringify(calculations));
      return calculation.id;
    }

    function getStoredCalculations() {
      const stored = localStorage.getItem('profitCalculations');
      return stored ? JSON.parse(stored) : [];
    }

    function deleteCalculationFromStorage(calculationId) {
      const calculations = getStoredCalculations();
      const filtered = calculations.filter(calc => calc.id !== calculationId);
      localStorage.setItem('profitCalculations', JSON.stringify(filtered));
    }

    // History panel functions
    function loadHistoryList() {
      const calculations = getStoredCalculations();
      const historyList = document.getElementById('historyList');
      const emptyHistory = document.getElementById('emptyHistory');
      
      if (calculations.length === 0) {
        historyList.innerHTML = '';
        emptyHistory.classList.remove('hidden');
        return;
      }
      
      emptyHistory.classList.add('hidden');
      
      // Sort by date (newest first)
      calculations.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      historyList.innerHTML = calculations.map(calc => {
        const date = new Date(calc.date);
        const timeStr = date.toLocaleString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const profitClass = calc.totalProfit >= 0 ? 'text-green-600' : 'text-red-600';
        const profitText = calc.totalProfit >= 0 ? 'á€¡á€™á€¼á€á€º' : 'á€¡á€›á€¾á€¯á€¶á€¸';
        
        return `
          <div class="mobile-share-card cursor-pointer hover:bg-gray-50" onclick="showDetail('${calc.id}')">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-medium">${calc.name}</h3>
                <p class="text-sm text-gray-500">${timeStr}</p>
              </div>
              <div class="text-right">
                <p class="text-sm text-gray-600">á€›á€±á€¬á€„á€ºá€¸á€…á€»á€±á€¸: ${formatNumber(calc.soldAmount)} MMK</p>
                <p class="text-sm ${profitClass}">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ ${profitText}: ${formatNumber(Math.abs(calc.totalProfit))} MMK</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Detail view functions
    function loadDetailView(calculationId) {
      const calculations = getStoredCalculations();
      const calculation = calculations.find(calc => calc.id === calculationId);
      
      if (!calculation) {
        document.getElementById('detailContent').innerHTML = '<p class="text-red-500">á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€€á€­á€¯ á€›á€¾á€¬á€™á€á€½á€±á€·á€•á€«á‹</p>';
        return;
      }
      
      document.getElementById('detailTitle').textContent = calculation.name;
      
      // Generate the same results HTML as the calculator
      const { users, totalInvestment, totalProfit } = calculation;
      
      // Desktop table
      let desktopResultsHTML = `
        <div class="overflow-x-auto hidden sm:block">
          <table class="min-w-full table-auto border border-gray-300">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-4 py-2">á€›á€¾á€šá€ºá€šá€¬á€›á€¾á€„á€ºá€¡á€™á€Šá€º</th>
                <th class="border px-4 py-2">á€•á€«á€á€„á€ºá€„á€½á€±</th>
                <th class="border px-4 py-2">á€•á€«á€á€„á€ºá€›á€¬á€á€­á€¯á€„á€ºá€”á€¾á€¯á€”á€ºá€¸</th>
                <th class="border px-4 py-2">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€•á€¼á€”á€ºá€›á€„á€½á€±</th>
                <th class="border px-4 py-2">á€¡á€™á€¼á€á€ºá€„á€½á€±</th>
              </tr>
            </thead>
            <tbody>
      `;

      users.forEach(user => {
        const percent = (user.amount / totalInvestment) * 100;
        const userProfit = totalProfit * (percent / 100);
        const totalReturn = user.amount + userProfit;
        const profitLossClass = userProfit >= 0 ? 'profit-text' : 'loss-text';
        const profitLossPrefix = userProfit >= 0 ? '' : '-';

        desktopResultsHTML += `
          <tr>
            <td class="border px-4 py-2">${user.name}</td>
            <td class="border px-4 py-2">${formatNumber(user.amount)}</td>
            <td class="border px-4 py-2">${percent.toFixed(2)}%</td>
            <td class="border px-4 py-2">${formatNumber(totalReturn)}</td>
            <td class="border px-4 py-2 ${profitLossClass}">${profitLossPrefix}${formatNumber(Math.abs(userProfit))}</td>
          </tr>
        `;
      });
      desktopResultsHTML += '</tbody></table></div>';

      // Mobile list
      let mobileResultsHTML = `<div class="sm:hidden space-y-3">`;
      users.forEach(user => {
        const percent = (user.amount / totalInvestment) * 100;
        const userProfit = totalProfit * (percent / 100);
        const totalReturn = user.amount + userProfit;
        const profitLossClass = userProfit >= 0 ? 'profit-text' : 'loss-text';
        const profitLossPrefix = userProfit >= 0 ? '' : '-';

        mobileResultsHTML += `
          <div class="mobile-share-card">
            <h3 class="mobile-share-name">${user.name}</h3>
            <div class="mobile-share-item">
              <span class="mobile-share-item-label">á€•á€«á€á€„á€ºá€„á€½á€±:</span>
              <span class="mobile-share-item-value">${formatNumber(user.amount)} MMK</span>
            </div>
            <div class="mobile-share-item">
              <span class="mobile-share-item-label">á€•á€«á€á€„á€ºá€›á€¬á€á€­á€¯á€„á€ºá€”á€¾á€¯á€”á€ºá€¸:</span>
              <span class="mobile-share-item-value">${percent.toFixed(2)}%</span>
            </div>
            <div class="mobile-share-item">
              <span class="mobile-share-item-label">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€•á€¼á€”á€ºá€›á€„á€½á€±:</span>
              <span class="mobile-share-item-value">${formatNumber(totalReturn)} MMK</span>
            </div>
            <div class="mobile-share-item">
              <span class="mobile-share-item-label">á€¡á€™á€¼á€á€ºá€„á€½á€±:</span>
              <span class="mobile-share-item-value ${profitLossClass}">${profitLossPrefix}${formatNumber(Math.abs(userProfit))} MMK</span>
            </div>
          </div>
        `;
      });
      mobileResultsHTML += '</div>';

      const overallProfitLossText = totalProfit >= 0 ? 'á€¡á€™á€¼á€á€º' : 'á€¡á€›á€¾á€¯á€¶á€¸';
      const overallProfitLossClass = totalProfit >= 0 ? 'profit-text' : 'loss-text';

      const summaryHTML = `
        <div class="mt-3 mobile-share-card">
          <h3 class="mobile-share-name">á€…á€¬á€›á€„á€ºá€¸á€¡á€”á€¾á€…á€ºá€á€»á€¯á€•á€º</h3>
          <div class="mobile-share-item">
            <span class="mobile-share-item-label">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€•á€«á€á€„á€ºá€„á€½á€±:</span>
            <span class="mobile-share-item-value">${formatNumber(totalInvestment)} MMK</span>
          </div>
          <div class="mobile-share-item">
            <span class="mobile-share-item-label">á€›á€±á€¬á€„á€ºá€¸á€…á€»á€±á€¸:</span>
            <span class="mobile-share-item-value">${formatNumber(calculation.soldAmount)} MMK</span>
          </div>
          <div class="mobile-share-item">
            <span class="mobile-share-item-label">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ ${overallProfitLossText}:</span>
            <span class="mobile-share-item-value ${overallProfitLossClass}">${formatNumber(Math.abs(totalProfit))} MMK</span>
          </div>
        </div>
      `;

      document.getElementById('detailContent').innerHTML = desktopResultsHTML + mobileResultsHTML + summaryHTML;
    }

    function loadCalculation() {
      const calculations = getStoredCalculations();
      const calculation = calculations.find(calc => calc.id === selectedCalculationId);
      
      if (!calculation) {
        alert('á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€€á€­á€¯ á€›á€¾á€¬á€™á€á€½á€±á€·á€•á€«á‹');
        return;
      }
      
      // Load the calculation data into the form
      document.getElementById('soldAmount').value = calculation.soldAmount;
      
      // Clear existing share fields
      const container = document.getElementById('sharesContainer');
      container.innerHTML = '';
      
      // Add share fields for each user
      calculation.users.forEach(user => {
        addShareField();
        const entries = container.querySelectorAll('.share-entry-container');
        const lastEntry = entries[entries.length - 1];
        lastEntry.querySelector('.share-name').value = user.name;
        lastEntry.querySelector('.share-amount').value = user.amount;
      });
      
      // Switch to calculator view
      showNewCalculation();
      alert('á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€€á€­á€¯ á€›á€šá€°á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹');
    }

    function deleteCalculation() {
      if (!selectedCalculationId) return;
      
      if (confirm('á€¤á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€€á€­á€¯ á€–á€»á€€á€ºá€œá€­á€¯á€á€Šá€ºá€™á€¾á€¬ á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?')) {
        deleteCalculationFromStorage(selectedCalculationId);
        showHistoryPanel(); // Go back to history view
        alert('á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€€á€­á€¯ á€–á€»á€€á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹');
      }
    }

    // Function to add a new share input field
    function addShareField() {
      const container = document.getElementById('sharesContainer');
      const div = document.createElement('div');
      div.className = 'share-entry-container';
      div.innerHTML = `
        <div class="share-entry flex space-x-2">
          <input type="text" class="share-name flex-1 border border-gray-300 rounded px-2 py-1" placeholder="á€›á€¾á€šá€ºá€šá€¬á€›á€¾á€„á€ºá€¡á€™á€Šá€º" />
          <div class="amount-remove-row flex-2 flex space-x-2 sm:contents">
            <input type="number" class="share-amount flex-1 border border-gray-300 rounded px-2 py-1" placeholder="á€•á€«á€á€„á€ºá€„á€½á€±" />
            <button onclick="removeShareField(this)" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm flex-shrink-0">Ã—</button>
          </div>
        </div>
      `;
      container.appendChild(div);
    }

    // Function to remove a share input field
    function removeShareField(button) {
      const container = document.getElementById('sharesContainer');
      const shareEntryContainer = button.closest('.share-entry-container');
      
      // Prevent removing the last remaining entry
      if (container.children.length > 1) {
        shareEntryContainer.remove();
      } else {
        alert('á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ á€›á€¾á€šá€ºá€šá€¬á€›á€¾á€„á€ºá€á€…á€ºá€šá€±á€¬á€€á€ºá€›á€¾á€­á€›á€™á€Šá€ºá‹');
      }
    }

    // Function to calculate profit and display results
    function calculateProfit() {
      const soldAmountInput = document.getElementById('soldAmount');
      const soldAmount = parseFloat(soldAmountInput.value);
      const entries = document.querySelectorAll('.share-entry-container');
      const resultsDiv = document.getElementById('results');

      // --- Input Validation for Sold Amount ---
      if (isNaN(soldAmount) || soldAmount <= 0) {
        resultsDiv.innerHTML = `
          <div class="error-message" role="alert">
            <strong class="font-bold">á€™á€¾á€¬á€¸á€šá€½á€„á€ºá€¸á€™á€¾á€¯!</strong>
            <span class="block sm:inline"> á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á á€™á€¾á€”á€ºá€€á€”á€ºá€á€±á€¬ á€›á€±á€¬á€„á€ºá€¸á€…á€»á€±á€¸á€€á€­á€¯ á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€•á€«á‹</span>
          </div>
        `;
        soldAmountInput.classList.add('border-red-500'); // Highlight error
        return; // Stop execution if validation fails
      } else {
        soldAmountInput.classList.remove('border-red-500'); // Remove highlight if valid
      }

      let totalInvestment = 0;
      const users = [];
      let hasInvalidShareInput = false;

      entries.forEach(entry => {
        const nameInput = entry.querySelector('.share-name');
        const amountInput = entry.querySelector('.share-amount');

        const name = nameInput.value.trim() || 'á€¡á€™á€Šá€ºá€™á€á€­';
        const amount = parseFloat(amountInput.value);

        if (isNaN(amount) || amount <= 0) {
          amountInput.classList.add('border-red-500'); // Highlight error
          hasInvalidShareInput = true;
        } else {
          amountInput.classList.remove('border-red-500'); // Remove highlight if valid
          users.push({ name, amount });
          totalInvestment += amount;
        }
      });

      // --- Input Validation for Share Amounts ---
      if (hasInvalidShareInput) {
        resultsDiv.innerHTML = `
          <div class="error-message" role="alert">
            <strong class="font-bold">á€™á€¾á€¬á€¸á€šá€½á€„á€ºá€¸á€™á€¾á€¯!</strong>
            <span class="block sm:inline"> á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á á€›á€¾á€šá€ºá€šá€¬á€›á€¾á€„á€ºá€™á€»á€¬á€¸á á€•á€«á€á€„á€ºá€„á€½á€±á€€á€­á€¯ á€™á€¾á€”á€ºá€€á€”á€ºá€…á€½á€¬ á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€•á€«á‹</span>
          </div>
        `;
        return;
      }

      // --- Edge Case: Zero Total Investment ---
      if (totalInvestment === 0) {
        resultsDiv.innerHTML = `
          <div class="warning-message" role="alert">
            <strong class="font-bold">á€á€á€­á€•á€¼á€¯á€›á€”á€º!</strong>
            <span class="block sm:inline"> á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á á€•á€«á€á€„á€ºá€„á€½á€±á€™á€»á€¬á€¸á€€á€­á€¯ á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€•á€«á‹</span>
          </div>
        `;
        return;
      }

      const profit = soldAmount - totalInvestment;

      // --- Desktop Table HTML ---
      let desktopResultsHTML = `
        <div class="overflow-x-auto hidden sm:block">
          <table class="min-w-full table-auto border border-gray-300">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-4 py-2">á€›á€¾á€šá€ºá€šá€¬á€›á€¾á€„á€ºá€¡á€™á€Šá€º</th>
                <th class="border px-4 py-2">á€•á€«á€á€„á€ºá€„á€½á€±</th>
                <th class="border px-4 py-2">á€•á€«á€á€„á€ºá€›á€¬á€á€­á€¯á€„á€ºá€”á€¾á€¯á€”á€ºá€¸</th>
                <th class="border px-4 py-2">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€•á€¼á€”á€ºá€›á€„á€½á€±</th>
                <th class="border px-4 py-2">á€¡á€™á€¼á€á€ºá€„á€½á€±</th>
              </tr>
            </thead>
            <tbody>
      `;

      users.forEach((user, index) => {
        const percent = (user.amount / totalInvestment) * 100;
        const userProfit = profit * (percent / 100);
        const totalReturn = user.amount + userProfit;

        const profitLossClass = userProfit >= 0 ? 'profit-text' : 'loss-text';
        const profitLossPrefix = userProfit >= 0 ? '' : '-';

        desktopResultsHTML += `
          <tr>
            <td class="border px-4 py-2">${user.name}</td>
            <td class="border px-4 py-2">${formatNumber(user.amount)}</td>
            <td class="border px-4 py-2">${percent.toFixed(2)}%</td>
            <td class="border px-4 py-2">${formatNumber(totalReturn)}</td>
            <td class="border px-4 py-2 ${profitLossClass}">${profitLossPrefix}${formatNumber(Math.abs(userProfit))}</td>
          </tr>
        `;
      });
      desktopResultsHTML += '</tbody></table></div>';

      // --- Mobile List HTML ---
      let mobileResultsHTML = `
        <div class="sm:hidden space-y-3">
      `;
      users.forEach((user, index) => {
        const percent = (user.amount / totalInvestment) * 100;
        const userProfit = profit * (percent / 100);
        const totalReturn = user.amount + userProfit;

        const profitLossClass = userProfit >= 0 ? 'profit-text' : 'loss-text';
        const profitLossPrefix = userProfit >= 0 ? '' : '-';

        mobileResultsHTML += `
          <div class="mobile-share-card">
            <h3 class="mobile-share-name">${user.name}</h3>
            <div class="mobile-share-item">
              <span class="mobile-share-item-label">á€•á€«á€á€„á€ºá€„á€½á€±:</span>
              <span class="mobile-share-item-value">${formatNumber(user.amount)} MMK</span>
            </div>
            <div class="mobile-share-item">
              <span class="mobile-share-item-label">á€•á€«á€á€„á€ºá€›á€¬á€á€­á€¯á€„á€ºá€”á€¾á€¯á€”á€ºá€¸:</span>
              <span class="mobile-share-item-value">${percent.toFixed(2)}%</span>
            </div>
            <div class="mobile-share-item">
              <span class="mobile-share-item-label">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€•á€¼á€”á€ºá€›á€„á€½á€±:</span>
              <span class="mobile-share-item-value">${formatNumber(totalReturn)} MMK</span>
            </div>
            <div class="mobile-share-item">
              <span class="mobile-share-item-label">á€¡á€™á€¼á€á€ºá€„á€½á€±:</span>
              <span class="mobile-share-item-value ${profitLossClass}">${profitLossPrefix}${formatNumber(Math.abs(userProfit))} MMK</span>
            </div>
          </div>
        `;
      });
      mobileResultsHTML += '</div>';

      const overallProfitLossText = profit >= 0 ? 'á€¡á€™á€¼á€á€º' : 'á€¡á€›á€¾á€¯á€¶á€¸';
      const overallProfitLossClass = profit >= 0 ? 'profit-text' : 'loss-text';

      const summaryHTML = `
        <div class="mt-3 mobile-share-card">
          <h3 class="mobile-share-name">á€…á€¬á€›á€„á€ºá€¸á€¡á€”á€¾á€…á€ºá€á€»á€¯á€•á€º</h3>
          <div class="mobile-share-item">
            <span class="mobile-share-item-label">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€•á€«á€á€„á€ºá€„á€½á€±:</span>
            <span class="mobile-share-item-value">${formatNumber(totalInvestment)} MMK</span>
          </div>
          <div class="mobile-share-item">
            <span class="mobile-share-item-label">á€›á€±á€¬á€„á€ºá€¸á€…á€»á€±á€¸:</span>
            <span class="mobile-share-item-value">${formatNumber(soldAmount)} MMK</span>
          </div>
          <div class="mobile-share-item">
            <span class="mobile-share-item-label">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ ${overallProfitLossText}:</span>
            <span class="mobile-share-item-value ${overallProfitLossClass}">${formatNumber(Math.abs(profit))} MMK</span>
          </div>
        </div>
      `;

      resultsDiv.innerHTML = desktopResultsHTML + mobileResultsHTML + summaryHTML;

      // Save the calculation to history (auto-save)
      const calculationData = {
        soldAmount,
        users,
        totalInvestment,
        totalProfit: profit
      };
      saveCalculation(calculationData);
    }

    // Summary view functions
    function initializeSummaryView() {
      populateYearFilter();
      updateSummary();
    }

    function populateYearFilter() {
      const calculations = getStoredCalculations();
      const years = [...new Set(calculations.map(calc => new Date(calc.date).getFullYear()))].sort((a, b) => b - a);
      
      const yearFilter = document.getElementById('yearFilter');
      yearFilter.innerHTML = '<option value="">á€”á€¾á€…á€ºá€¡á€¬á€¸á€œá€¯á€¶á€¸</option>';
      
      years.forEach(year => {
        yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
      });
    }

    function updateSummary() {
      const calculations = getStoredCalculations();
      const yearFilter = document.getElementById('yearFilter').value;
      const monthFilter = document.getElementById('monthFilter').value;
      
      // Filter calculations based on selected filters
      const filteredCalculations = calculations.filter(calc => {
        const calcDate = new Date(calc.date);
        
        if (yearFilter && calcDate.getFullYear() !== parseInt(yearFilter)) {
          return false;
        }
        
        if (monthFilter !== '' && calcDate.getMonth() !== parseInt(monthFilter)) {
          return false;
        }
        
        return true;
      });
      
      // Calculate summary statistics
      const totalCalculations = filteredCalculations.length;
      const totalInvestmentSum = filteredCalculations.reduce((sum, calc) => sum + calc.totalInvestment, 0);
      const totalSoldAmountSum = filteredCalculations.reduce((sum, calc) => sum + calc.soldAmount, 0);
      const totalProfitSum = filteredCalculations.reduce((sum, calc) => sum + calc.totalProfit, 0);
      
      // Update statistics display
      const summaryStats = document.getElementById('summaryStats');
      const profitClass = totalProfitSum >= 0 ? 'text-green-600' : 'text-red-600';
      const profitText = totalProfitSum >= 0 ? 'á€¡á€™á€¼á€á€º' : 'á€¡á€›á€¾á€¯á€¶á€¸';
      
      summaryStats.innerHTML = `
        <div class="mobile-share-card">
          <h3 class="mobile-share-name">á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€¡á€›á€±á€¡á€á€½á€€á€º</h3>
          <p class="text-2xl font-bold text-blue-600">${totalCalculations}</p>
        </div>
        <div class="mobile-share-card">
          <h3 class="mobile-share-name">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€•á€«á€á€„á€ºá€„á€½á€±</h3>
          <p class="text-lg font-bold text-blue-800">${formatNumber(totalInvestmentSum)} MMK</p>
        </div>
        <div class="mobile-share-card">
          <h3 class="mobile-share-name">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€›á€±á€¬á€„á€ºá€¸á€„á€½á€±</h3>
          <p class="text-lg font-bold text-gray-800">${formatNumber(totalSoldAmountSum)} MMK</p>
        </div>
        <div class="mobile-share-card">
          <h3 class="mobile-share-name">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ ${profitText}</h3>
          <p class="text-lg font-bold ${profitClass}">${formatNumber(Math.abs(totalProfitSum))} MMK</p>
        </div>
      `;
      
      // Update filtered calculations list
      displayFilteredCalculations(filteredCalculations);
    }

    function displayFilteredCalculations(calculations) {
      const filteredCalculations = document.getElementById('filteredCalculations');
      
      if (calculations.length === 0) {
        filteredCalculations.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <p>á€›á€½á€±á€¸á€á€»á€šá€ºá€‘á€¬á€¸á€á€±á€¬ á€…á€…á€ºá€‘á€¯á€á€ºá€™á€¾á€¯á€¡á€á€½á€€á€º á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€™á€»á€¬á€¸á€™á€›á€¾á€­á€•á€«á‹</p>
          </div>
        `;
        return;
      }
      
      // Sort by date (newest first)
      calculations.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      let html = '<h3 class="text-lg font-semibold mb-3">á€…á€…á€ºá€‘á€¯á€á€ºá€‘á€¬á€¸á€á€±á€¬ á€á€½á€€á€ºá€á€»á€€á€ºá€™á€¾á€¯á€™á€»á€¬á€¸</h3>';
      
      html += calculations.map(calc => {
        const date = new Date(calc.date);
        const timeStr = date.toLocaleString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const profitClass = calc.totalProfit >= 0 ? 'text-green-600' : 'text-red-600';
        const profitText = calc.totalProfit >= 0 ? 'á€¡á€™á€¼á€á€º' : 'á€¡á€›á€¾á€¯á€¶á€¸';
        
        return `
          <div class="mobile-share-card cursor-pointer hover:bg-gray-50" onclick="showDetail('${calc.id}')">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-medium">${calc.name}</h4>
                <p class="text-sm text-gray-500">${timeStr}</p>
              </div>
              <div class="text-right">
                <p class="text-sm text-gray-600">á€›á€±á€¬á€„á€ºá€¸á€…á€»á€±á€¸: ${calc.soldAmount.toLocaleString()} MMK</p>
                <p class="text-sm text-gray-600">á€•á€«á€á€„á€ºá€„á€½á€±: ${calc.totalInvestment.toLocaleString()} MMK</p>
                <p class="text-sm ${profitClass}">${profitText}: ${Math.abs(calc.totalProfit).toLocaleString()} MMK</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      filteredCalculations.innerHTML = html;
    }

    function clearFilters() {
      document.getElementById('yearFilter').value = '';
      document.getElementById('monthFilter').value = '';
      updateSummary();
    }
  </script>
</body>
</html>
